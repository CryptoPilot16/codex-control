#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="${ENV_FILE:-$SCRIPT_DIR/.env}"

if [[ -f "$ENV_FILE" ]]; then
  set -a
  # shellcheck source=/dev/null
  source "$ENV_FILE"
  set +a
fi

: "${PUSHOVER_APP_TOKEN:?Missing PUSHOVER_APP_TOKEN}"
: "${PUSHOVER_USER_KEY:?Missing PUSHOVER_USER_KEY}"
: "${APPROVE_SECRET:?Missing APPROVE_SECRET}"

TMUX_SESSION="${TMUX_SESSION:-codex:0.0}"
APPROVE_PORT="${APPROVE_PORT:-8787}"
APPROVE_HOST="${APPROVE_HOST:-127.0.0.1}"
APPROVE_URL="${APPROVE_URL:-http://${APPROVE_HOST}:${APPROVE_PORT}/approve}"
LOG_FILE="${CODEX_WATCH_LOG:-/tmp/codex_watch.log}"

# Ensure approval link carries secret for webhook auth.
if [[ "$APPROVE_URL" != *"secret="* ]]; then
  if [[ "$APPROVE_URL" == *"?"* ]]; then
    APPROVE_URL="${APPROVE_URL}&secret=${APPROVE_SECRET}"
  else
    APPROVE_URL="${APPROVE_URL}?secret=${APPROVE_SECRET}"
  fi
fi

# Prevent spamming every 2 seconds.
LAST_SENT_FILE="${LAST_SENT_FILE:-/tmp/codex_approval_last_sent}"
COOLDOWN_SECONDS="${COOLDOWN_SECONDS:-30}"

now_ts() { date +%s; }

should_send() {
  if [[ -f "$LAST_SENT_FILE" ]]; then
    local last
    last=$(cat "$LAST_SENT_FILE" || echo 0)
    (( $(now_ts) - last >= COOLDOWN_SECONDS ))
  else
    return 0
  fi
}

send_push() {
  local resp
  resp=$(curl -s \
    -F "token=$PUSHOVER_APP_TOKEN" \
    -F "user=$PUSHOVER_USER_KEY" \
    -F "title=Codex Approval Needed" \
    -F "message=Tap Approve to continue" \
    -F "url=$APPROVE_URL" \
    -F "url_title=Approve" \
    https://api.pushover.net/1/messages.json)

  echo "$(date) pushover_resp=$resp" >> "$LOG_FILE"
}

IN_PROMPT=0

LAST_SIG_FILE="/tmp/codex_last_prompt_sig"

while true; do
  pane="$(tmux capture-pane -pt "$TMUX_SESSION" -S -120 2>/dev/null || true)"

  # Extract the most recent command line from the approval prompt
  # This grabs the last line that starts with "$ " in the pane.
  sig="$(echo "$pane" | grep -E '^\$ ' | tail -n 1 | sed 's/[[:space:]]\+/ /g')"

  # Are we currently in an approval screen (look for confirm line near the bottom)?
  in_prompt=0
  echo "$pane" | tail -n 80 | grep -Eq "Press enter to confirm|Would you like to run" && in_prompt=1

  if [[ "$in_prompt" -eq 1 && -n "$sig" ]]; then
    last_sig="$(cat "$LAST_SIG_FILE" 2>/dev/null || true)"

    # Only notify if the command signature changed
    if [[ "$sig" != "$last_sig" ]]; then
      echo "$sig" > "$LAST_SIG_FILE"
      echo "$(date) detected new prompt sig=$sig" >> /tmp/codex_watch.log
      send_push || echo "$(date) send_push failed" >> /tmp/codex_watch.log
    fi
  fi

  sleep 0.5
done
